<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Recipe Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Smart Recipe Generator</h1>

    <!-- Ingredients input -->
    <div class="mb-3">
        <label for="ingredients" class="form-label">Available Ingredients (comma-separated):</label>
        <input type="text" class="form-control" id="ingredients" placeholder="e.g., tomato, pasta, cheese">
    </div>

    <!-- Dietary preference -->
    <div class="mb-3">
        <label for="dietary" class="form-label">Dietary Preference:</label>
        <select class="form-select" id="dietary">
            <option value="Any">Any</option>
            <option value="Vegetarian">Vegetarian</option>
            <option value="Vegan">Vegan</option>
            <option value="Non-Vegetarian">Non-Vegetarian</option>
            <option value="Gluten-Free">Gluten-Free</option>
        </select>
    </div>

    <!-- Difficulty -->
    <div class="mb-3">
        <label for="difficulty" class="form-label">Difficulty:</label>
        <select class="form-select" id="difficulty">
            <option value="Any">Any</option>
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
        </select>
    </div>

    <!-- Max cooking time -->
    <div class="mb-3">
        <label for="maxCookingTime" class="form-label">Maximum Cooking Time (minutes):</label>
        <input type="number" class="form-control" id="maxCookingTime" placeholder="e.g., 30">
    </div>

    <!-- Find recipes button -->
    <div class="mb-3">
        <button class="btn btn-primary" id="submitBtn">Find Recipes</button>
        <button class="btn btn-outline-success" id="favoritesToggle">Show Only Favorites</button>
    </div>

    <hr>

    <!-- Image upload -->
    <div class="mb-3">
        <label for="imageUpload" class="form-label">Upload Ingredient Image:</label>
        <input type="file" class="form-control" id="imageUpload">
    </div>
    <div class="mb-3">
        <button class="btn btn-secondary" id="uploadBtn">Detect Ingredients</button>
    </div>

    <hr>

    <!-- Message display -->
    <div id="message" class="my-3"></div>

    <!-- Recipes container -->
    <div class="row" id="recipesContainer"></div>
</div>

<script>
    let allRecipes = [];
    let showOnlyFavorites = false;

    async function fetchRecipes() {
        const ingredientsInput = document.getElementById('ingredients').value.trim();
        const ingredients = ingredientsInput ? ingredientsInput.split(',').map(s => s.trim().toLowerCase()) : [];
        const dietary = document.getElementById('dietary').value;
        const difficulty = document.getElementById('difficulty').value;
        const maxCookingTime = document.getElementById('maxCookingTime').value;

        document.getElementById('message').innerHTML = '<div>Loading recipes...</div>';
        document.getElementById('recipesContainer').innerHTML = '';

        try {
            const response = await fetch('/api/recipes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    availableIngredients: ingredients,
                    dietary: dietary,
                    difficulty: difficulty,
                    maxCookingTime: maxCookingTime ? parseInt(maxCookingTime) : null
                })
            });

            const recipes = await response.json();
            document.getElementById('message').innerHTML = '';

            if (recipes.length === 0) {
                document.getElementById('message').innerHTML = '<div>No matching recipes found.</div>';
                return;
            }

            allRecipes = recipes;
            renderRecipes();
        } catch (err) {
            console.error(err);
            document.getElementById('message').innerHTML = '<div class="text-danger">Error fetching recipes.</div>';
        }
    }

    function renderRecipes() {
        const container = document.getElementById('recipesContainer');
        container.innerHTML = '';

        const filteredRecipes = showOnlyFavorites
            ? allRecipes.filter(r => r.favorite)
            : allRecipes;

        filteredRecipes.forEach(recipe => {
            const card = document.createElement('div');
            card.className = 'col-md-6 mb-3';
            card.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5>${recipe.name}</h5>
                        <p><strong>Ingredients:</strong> ${recipe.ingredients.join(', ')}</p>
                        <p><strong>Steps:</strong> ${recipe.steps.join(' → ')}</p>
                        <p><strong>Calories:</strong> ${recipe.calories} kcal</p>
                        <p><strong>Protein:</strong> ${recipe.protein} g</p>
                        <p><strong>Difficulty:</strong> ${recipe.difficulty}</p>
                        <p><strong>Cooking Time:</strong> ${recipe.cookingTime} min</p>
                        <p><strong>Dietary:</strong> ${recipe.dietary}</p>
                        <p><strong>Average Rating:</strong> ${recipe.averageRating.toFixed(1)} ⭐</p>
                        <div class="mb-2">
                            <select class="form-select form-select-sm d-inline w-auto" id="ratingSelect-${recipe.name}">
                                <option value="1">1 ⭐</option>
                                <option value="2">2 ⭐</option>
                                <option value="3">3 ⭐</option>
                                <option value="4">4 ⭐</option>
                                <option value="5" selected>5 ⭐</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" onclick="rateRecipe('${recipe.name}')">Rate</button>
                        </div>
                        <button class="btn btn-sm ${recipe.favorite ? 'btn-warning' : 'btn-outline-warning'}" onclick="toggleFavorite('${recipe.name}')">
                            ${recipe.favorite ? '★ Unfavorite' : '☆ Favorite'}
                        </button>
                    </div>
                </div>`;
            container.appendChild(card);
        });
    }

    async function rateRecipe(recipeName) {
        const ratingSelect = document.getElementById(`ratingSelect-${recipeName}`);
        const rating = ratingSelect.value;

        try {
            await fetch(`/api/recipes/${encodeURIComponent(recipeName)}/rate?rating=${rating}`, {
                method: 'POST'
            });
            alert(`Thank you for rating "${recipeName}" with ${rating} stars!`);
            fetchRecipes();
        } catch (err) {
            console.error(err);
            alert('Error submitting rating.');
        }
    }

    async function toggleFavorite(recipeName) {
        try {
            await fetch(`/api/recipes/${encodeURIComponent(recipeName)}/favorite`, {
                method: 'POST'
            });
            fetchRecipes();
        } catch (err) {
            console.error(err);
            alert('Error toggling favorite.');
        }
    }

    document.getElementById('submitBtn').addEventListener('click', fetchRecipes);

    document.getElementById('favoritesToggle').addEventListener('click', () => {
        showOnlyFavorites = !showOnlyFavorites;
        document.getElementById('favoritesToggle').textContent = showOnlyFavorites ? 'Show All Recipes' : 'Show Only Favorites';
        renderRecipes();
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('imageUpload');
        if (!fileInput.files.length) {
            alert('Please select an image file.');
            return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);

        try {
            const response = await fetch('/api/recipes/detect', {
                method: 'POST',
                body: formData
            });
            const ingredients = await response.json();
            document.getElementById('ingredients').value = ingredients.join(', ');
            alert('Detected ingredients: ' + ingredients.join(', '));
        } catch (err) {
            console.error(err);
            alert('Error detecting ingredients.');
        }
    });
</script>

</body>
</html>
